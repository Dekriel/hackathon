<!DOCTYPE html>
<html lang="en">
  <script>
    var canvas;
    var ctx;
    var width;
    var height;

    let char_lookup = {
      'r': 'rook',
      'b': 'bishop',
      'n': 'knight',
      'q': 'queen',
      'k': 'king',
      'p': 'pawn',
    };

    function getColour(ch) {
      if (ch.toLowerCase() === ch) {
        return 'white';
      }

      else {
        return 'black';
      }
    }

    function draw_chess_board() {
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          if (row % 2 != col % 2) continue;
          let [x, y] = get_bottom_left(col, row);
          ctx.beginPath();
          ctx.rect(x, y, width, height);
          ctx.fillStyle = '#aaaaaa';
          ctx.fill();
        }
      }
    }

    // origin is top left
    function get_bottom_left(x, y) {
      console.assert(x < 8 && x >= 0);
      console.assert(y < 8 && y >= 0);

      return [width * x, height * (7 - y)];
    }

    async function get_game_state() {
      return await fetch('state')
        .then((response) => response.json())
        .then((data) => {return data['board']});
    }

    async function draw_game_state() {
      let game_state = await get_game_state();
      console.log(game_state);
      var startrow = 0;
      var startcol = 0;
      for (let step = 0; step < game_state.length; step++) {
        let c = game_state[step];
        if (c == 'V') {
            startrow = startrow + 1;
            startcol = 0;
        }
        else if (c.toLowerCase() in char_lookup) {
            let whatColour = getColour(c);
            draw_image(whatColour, char_lookup[c.toLowerCase()], startcol, startrow);
            startcol = startcol + 1;
        }
      }
    }

    function draw_image(color, piece, row, col) {
      row = 7 - row;
      col = 7 - col;
      let [x, y] = get_bottom_left(col, row);
      var img = document.createElement('img');
      img.onload = function() {
        ctx.drawImage(this, y, x, width, height);
      };
      img.onerror = function() {
      	ctx.fillStyle = 'red';
      	ctx.font = '16px Arial';
       	ctx.fillText('Image loading error!', 10, 30);
      };
      img.src = "assets/chess_pieces/".concat(color).concat('/').concat(piece).concat('.png');
    }
    
    function init() {
      canvas = document.getElementById('myCanvas');
      ctx = canvas.getContext('2d');
      width = canvas.width / 8;
      height = canvas.height / 8;

      draw_chess_board();

      // generate the layout for black
      
      draw_game_state();
    }

  </script>
  <body onload="init()">
  	<div style="text-align:center;">
      <canvas id="myCanvas" width="500" height="500" style="border:1px solid"></canvas>
    </div>
  </body>
</html>

